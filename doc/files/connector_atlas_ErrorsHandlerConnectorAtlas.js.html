<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>connector/atlas/ErrorsHandlerConnectorAtlas.js - DNSMON</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="DNSMON"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 14.4.29.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AggregationLevelConnector.html">AggregationLevelConnector</a></li>
            
                <li><a href="../classes/AntiFloodConnector.html">AntiFloodConnector</a></li>
            
                <li><a href="../classes/BreadcrumbsView.html">BreadcrumbsView</a></li>
            
                <li><a href="../classes/CacheConnectorAtlas.html">CacheConnectorAtlas</a></li>
            
                <li><a href="../classes/Cell.html">Cell</a></li>
            
                <li><a href="../classes/Connector.html">Connector</a></li>
            
                <li><a href="../classes/ConnectorFacade.html">ConnectorFacade</a></li>
            
                <li><a href="../classes/ControlPanelView.html">ControlPanelView</a></li>
            
                <li><a href="../classes/ErrorsHandlerConnectorAtlas.html">ErrorsHandlerConnectorAtlas</a></li>
            
                <li><a href="../classes/FullScreenView.html">FullScreenView</a></li>
            
                <li><a href="../classes/GesturesManager.html">GesturesManager</a></li>
            
                <li><a href="../classes/HistoryManager.html">HistoryManager</a></li>
            
                <li><a href="../classes/IsolationLevelConnectorAtlas.html">IsolationLevelConnectorAtlas</a></li>
            
                <li><a href="../classes/MainView.html">MainView</a></li>
            
                <li><a href="../classes/ParamsManager.html">ParamsManager</a></li>
            
                <li><a href="../classes/PopUpView.html">PopUpView</a></li>
            
                <li><a href="../classes/Row.html">Row</a></li>
            
                <li><a href="../classes/SessionManager.html">SessionManager</a></li>
            
                <li><a href="../classes/SvgChartView.html">SvgChartView</a></li>
            
                <li><a href="../classes/SvgContainerView.html">SvgContainerView</a></li>
            
                <li><a href="../classes/SvgOrdinalAxisView.html">SvgOrdinalAxisView</a></li>
            
                <li><a href="../classes/SvgTimeAxisView.html">SvgTimeAxisView</a></li>
            
                <li><a href="../classes/TemplateManagerView.html">TemplateManagerView</a></li>
            
                <li><a href="../classes/TimeController.html">TimeController</a></li>
            
                <li><a href="../classes/TimeOverviewView.html">TimeOverviewView</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/connector.html">connector</a></li>
            
                <li><a href="../modules/connector.Atlas.html">connector.Atlas</a></li>
            
                <li><a href="../modules/controller.html">controller</a></li>
            
                <li><a href="../modules/environment.html">environment</a></li>
            
                <li><a href="../modules/model.html">model</a></li>
            
                <li><a href="../modules/session.html">session</a></li>
            
                <li><a href="../modules/view.html">view</a></li>
            
                <li><a href="../modules/view.svg.html">view.svg</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: connector/atlas/ErrorsHandlerConnectorAtlas.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Created with JetBrains WebStorm.
 * User: mcandela
 * Date: 10/16/13
 * Time: 4:27 PM
 * To change this template use File | Settings | File Templates.
 */

define([
    &quot;env.utils&quot;,
    &quot;connector.atlas.rest&quot;
], function(utils, Connector){

    /**
     * ErrorsHandlerConnectorAtlas checks the validity of the JSON input and handle errors raised by the data-api.
     *
     * @class ErrorsHandlerConnectorAtlas
     * @constructor
     * @module connector.Atlas
     */

    var ErrorsHandlerConnectorAtlas = function(env){
        var connector, errorsNomenclature, responsivenessTimer, lastRequestWorkingParams,
            restoringAttempt, config, firstConnection;

        connector = new Connector(env);
        config = env.config;
        firstConnection = true;

        this.globalErrorState = 0; // 0 - No error

        errorsNomenclature = {
            messages: &quot;messages&quot;,

            message: {
                text: &quot;text&quot;,
                type: &quot;type&quot;
            }
        };

        /**
         * From bottom to top: check the JSON validity and handles the error raised by the data-api.
         *
         * @method retrieveData
         * @param {Object} params A params vector
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this.retrieveData = function(params, callback, context){

            this.globalErrorState = 0; // Reset the global error state

            this._responsivenessCheck();

            connector.retrieveData(params,
                function(data){

                    clearTimeout(responsivenessTimer);

                    this._handleDataApiErrors(data); // This can change the global error state

                    if (this.globalErrorState &lt; 3){ // retry still active

                        if (this.globalErrorState &lt;= 1){ //If there are no blocking errors

                            if (this._checkDataFormat(data)){ //If the json format is correct

                                lastRequestWorkingParams = utils.lightClone(params); // Store last working request
                                firstConnection = false;

                                callback.call(context, data);

                            }else{ //If the json format is malformed

                                this._handle(&quot;error&quot;, env.lang.malformedDataset);
                                env.mainView.loadingImage(false);

                            }

                        }else { // There is at least one blocking error

                            this.globalErrorState = 0; // Reset it for the next error

                            if (env.isUpdatedPeriodicallyActive == false) { // Network error with auto-update disabled
                                this._tryToReconnect(params, callback, context);
                            } else {
                                env.mainView.showMessage(env.lang.lastQueryFails);
                            }
                        }
                    }

                }, this);

        };


        /**
         * This method tries to reconnect to the server in case of failures and provides a feedback to the user.
         *
         * @method _tryToReconnect
         * @private
         * @param {Object} params A params vector
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this._tryToReconnect = function(params, callback, context){
            var $this;

            $this = this;
            setTimeout(function(){

                env.mainView.showMessage(env.lang.waitingConnection);

                utils.log(&#x27;Try to reconnect&#x27;, env.debugMode);
                $this.retrieveData(params, callback, context);

            }, config.reconnectionInterval);

        };


        /**
         * This method tries to restore the previous working query in case of failures and provides a feedback to the user.
         *
         * @method _restorePreviousWorkingQuery
         * @private
         * @param {Object} params A params vector
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this._restorePreviousWorkingQuery = function(callback, context){
            var $this;

            $this = this;

            utils.log(&#x27;Try to restore the previous situation&#x27;, env.debugMode);

            env.params = lastRequestWorkingParams;
            connector.retrieveData(lastRequestWorkingParams, callback, context);
        };


        /**
         * This method dispatches to _handle all the data-api errors
         *
         * @method _handleDataApiErrors
         * @private
         * @param {Object} data The data blob retrieved from the data-api
         */

        this._handleDataApiErrors = function(data){
            var errorsTmp, errorTmp, errorNomenclature;
            errorsTmp = data[errorsNomenclature.messages];

            if (errorsTmp){
                errorNomenclature = errorsNomenclature.message;

                for (var n=0,length=errorsTmp.length; n&lt;length &amp;&amp; this.globalErrorState &lt;3; n++){
                    errorTmp = errorsTmp[n];
                    this._handle(errorTmp[errorNomenclature.type], errorTmp[errorNomenclature.text]);
                    env.mainView.loadingImage(false);
                }
            }
        };


        /**
         * It provides a different method to handle each error raised from the data-api.
         *
         * @method _handle
         * @private
         * @param {String} type A string representing the type of the error
         * @return {String} type A string describing the error
         */

        this._handle = function(type, text){
            switch(type){

                case &quot;connection-fail&quot;:
                    env.mainView.showMessage(env.lang.connectionFailed);
                    this._setGlobalErrorState(2); // 2 - Blocking error, retry
                    break;

                case &quot;error&quot;:
                    env.mainView.showMessage(text);
                    this._setGlobalErrorState(3); // 3 - Blocking error, no retry
                    break;

                case &quot;info&quot;:
                    env.mainView.showMessage(text);
                    this._setGlobalErrorState(1); // 1 - The show must go on
                    break;
            }
        };


        /**
         * This method sets the global error state.
         * A global error is a blocking error that can not be handled by other components of the tool
         *
         * @method _setGlobalErrorState
         * @private
         * @param {Number} errorLevel An integer representing the current error state
         */

        this._setGlobalErrorState = function(errorLevel){
            this.globalErrorState = errorLevel;
        };


        /**
         * It checks if the retrieved JSON contains all the mandatory fields for all the possible views.
         *
         * @method _checkDataFormat
         * @private
         * @return {Boolean} Returns true on success
         */

        this._checkDataFormat = function(data){
            var requiredFields;

            requiredFields = {};

            requiredFields[&quot;zone-servers&quot;] = [&quot;start_time&quot;, &quot;end_time&quot;, &quot;earliest_available&quot;, &quot;latest_available&quot;, &quot;aggregation&quot;, &quot;aggregation_levels&quot;, &quot;native_available&quot;, &quot;servers&quot;, &quot;group&quot;];
            requiredFields[&quot;server-probes&quot;] = [&quot;start_time&quot;, &quot;end_time&quot;, &quot;earliest_available&quot;, &quot;latest_available&quot;, &quot;aggregation&quot;, &quot;aggregation_levels&quot;, &quot;native_available&quot;, &quot;probes&quot;, &quot;group&quot;, &quot;server&quot;];


            return this._checkAllFields(data, requiredFields[&quot;zone-servers&quot;]) || this._checkAllFields(data, requiredFields[&quot;server-probes&quot;]);
        };


        /**
         * It checks if the retrieved JSON contains all the mandatory fields.
         *
         * @method _checkAllFields
         * @private
         * @return {Boolean} Returns true on success
         */
        this._checkAllFields = function(data, list){
            for (var n=0,length=list.length; n&lt;length; n++){
                if (!this._checkField(data, list[n])){
                    return false;
                }
            }
            return true;
        };


        /**
         * It checks if the retrieved JSON contains a certain mandatory field.
         *
         * @method _checkField
         * @private
         * @return {Boolean} Returns true on success
         */
        this._checkField = function(data, field){
            var item, presence, emptiness;

            item = data[field];

            presence = (item != null);
            emptiness = ($.isArray(item)) ? (item.length &gt; 0) : (item !== &quot;&quot;);

            return presence &amp;&amp; emptiness;
        };


        /**
         * It checks the responsiveness of the data-api to provide a feedback to the user.
         *
         * @method _responsivenessCheck
         * @private
         */

        this._responsivenessCheck = function(){
            var $this = this;

            responsivenessTimer = setTimeout(function(){
                $this._handle.call($this, &quot;info&quot;, env.lang.serverSlowMessage);
            }, 7 * 1000);
        };


        /**
         * Get the human readable version of the DNS response and check errors
         *
         * @method getNativeDnsResult
         * @param {Number} msmId The id of the measurement
         * @param {Number} prbId The id of the probe
         * @param {Number} timestamp A UNIX timestamp
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this.getNativeDnsResult = function(msmId, prbId, timestamp, callback, context){ // Just indirection for now

            // No errors checks for now
            connector.getNativeDnsResult(msmId, prbId, timestamp, callback, context);
        };


        /**
         * Get the closest traceroutes and checks errors
         *
         * @method getClosestTraceroutes
         * @param {Number} msmId The id of the measurement
         * @param {Number} prbId The id of the probe
         * @param {Number} timestamp A UNIX timestamp
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this.getClosestTraceroutes = function(msmId, prbId, timestamp, callback, context){ // Just indirection for now

            // No errors checks for now
            connector.getClosestTraceroutes(msmId, prbId, timestamp, callback, context);
        };

    };

    return ErrorsHandlerConnectorAtlas;
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
