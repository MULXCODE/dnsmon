<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>connector/ConnectorFacade.js - DNSMON</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="DNSMON"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 14.4.25.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AggregationLevelConnector.html">AggregationLevelConnector</a></li>
            
                <li><a href="../classes/AntiFloodConnector.html">AntiFloodConnector</a></li>
            
                <li><a href="../classes/BreadcrumbsView.html">BreadcrumbsView</a></li>
            
                <li><a href="../classes/CacheConnectorAtlas.html">CacheConnectorAtlas</a></li>
            
                <li><a href="../classes/Cell.html">Cell</a></li>
            
                <li><a href="../classes/Connector.html">Connector</a></li>
            
                <li><a href="../classes/ConnectorFacade.html">ConnectorFacade</a></li>
            
                <li><a href="../classes/ControlPanelView.html">ControlPanelView</a></li>
            
                <li><a href="../classes/ErrorsHandlerConnectorAtlas.html">ErrorsHandlerConnectorAtlas</a></li>
            
                <li><a href="../classes/FullScreenView.html">FullScreenView</a></li>
            
                <li><a href="../classes/GesturesManager.html">GesturesManager</a></li>
            
                <li><a href="../classes/HistoryManager.html">HistoryManager</a></li>
            
                <li><a href="../classes/IsolationLevelConnectorAtlas.html">IsolationLevelConnectorAtlas</a></li>
            
                <li><a href="../classes/MainView.html">MainView</a></li>
            
                <li><a href="../classes/ParamsManager.html">ParamsManager</a></li>
            
                <li><a href="../classes/PopUpView.html">PopUpView</a></li>
            
                <li><a href="../classes/Row.html">Row</a></li>
            
                <li><a href="../classes/SessionManager.html">SessionManager</a></li>
            
                <li><a href="../classes/SvgChartView.html">SvgChartView</a></li>
            
                <li><a href="../classes/SvgContainerView.html">SvgContainerView</a></li>
            
                <li><a href="../classes/SvgOrdinalAxisView.html">SvgOrdinalAxisView</a></li>
            
                <li><a href="../classes/SvgTimeAxisView.html">SvgTimeAxisView</a></li>
            
                <li><a href="../classes/TemplateManagerView.html">TemplateManagerView</a></li>
            
                <li><a href="../classes/TimeController.html">TimeController</a></li>
            
                <li><a href="../classes/TimeOverviewView.html">TimeOverviewView</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/connector.html">connector</a></li>
            
                <li><a href="../modules/connector.Atlas.html">connector.Atlas</a></li>
            
                <li><a href="../modules/controller.html">controller</a></li>
            
                <li><a href="../modules/environment.html">environment</a></li>
            
                <li><a href="../modules/model.html">model</a></li>
            
                <li><a href="../modules/session.html">session</a></li>
            
                <li><a href="../modules/view.html">view</a></li>
            
                <li><a href="../modules/view.svg.html">view.svg</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: connector/ConnectorFacade.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * Created by mcandela on 23/01/14.
 */

define([
    &quot;env.utils&quot;,
    &quot;connector.anti-flood&quot;,
    &quot;env.params-manager&quot;
], function(utils, Connector, paramsManager){

    /**
     * ConnectorFacade is the singleton Facade of the whole connector level.
     * It provides high-level connectivity functions able to receive as input model objects and converting
     * them in low-level parameters.
     *
     * @class ConnectorFacade
     * @constructor
     * @module connector
     */

    var ConnectorFacade = function(env){
        var connector, indexedRows;

        connector = new Connector(env);


        /**
         * From top to bottom: it provides a way to query the data-api with the current valid parameters.
         *
         * @method retrieveData
         * @param {Object} params A parameters vector
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this.retrieveData = function(callback, context){

            env.lastRequest = new Date();
            connector.retrieveData(env.params, function(data){
                this.rows = data.rows;
                this.group = data.group;

                env.lastUpdate = new Date();
                if (callback){
                    callback.call(context, data);
                }
            }, this);


        };

        /** Get all the rows
         *
         * @method getRows
         * @return {Array} A list of rows
         */

        this.getRows = function(){
            if (!this.rows){
                this.retrieveData();
            }

            return this.rows;
        };


        /** Get a row given an id
         *
         * @method getRowById
         * @param {Number} id An id
         * @return {Object} A row of the model layer
         */

        this.getRowById = function(id){
            var rows, row;

            if (!indexedRows){

                rows = this.getRows();
                indexedRows = {};

                for (var n=0,length=rows.length; n&lt;length; n++){
                    row = rows[n];
                    indexedRows[row.id] = row;
                }

            }
            return indexedRows[id];
        };


        /** Get the group of the last query
         *
         * @method getGroup
         * @return {Object} A group
         */

        this.getGroup = function(){
            return this.group;
        };


        /** Get additional data-api URLs given a cell
         *
         * @method getCellDataUrls
         * @param {Object} cell A cell object
         * @return {Object} A map of URLs for the selected sample
         */

        this.getCellDataUrls = function(cell){
            var listSampleUrls, urlTmp, row;

            row = cell.row;
            listSampleUrls = row.urlsMap.sample;

            for (var n=0,length=listSampleUrls.length; n&lt;length; n++){
                urlTmp = listSampleUrls[n];

                urlTmp.url = utils.setParam(&#x27;format&#x27;, &#x27;json&#x27;, urlTmp.url);

                if (row.___type___ == &quot;probe&quot;){
                    urlTmp.url = utils.setParam(&#x27;prb_id&#x27;, paramsManager.convertLocalToRemoteId(row.id), urlTmp.url);
                }

                urlTmp.url = utils.setParam(&#x27;start&#x27;, paramsManager.convertLocalToRemoteDate(cell.time), urlTmp.url);

                if (cell.endTime){
                    urlTmp.url = utils.setParam(&#x27;stop&#x27;, paramsManager.convertLocalToRemoteDate(cell.endTime), urlTmp.url);
                }else{
                    urlTmp.url = utils.setParam(&#x27;stop&#x27;, paramsManager.convertLocalToRemoteDate(new Date(cell.time.getTime() + (env.retrievedAggregationLevel * 1000))), urlTmp.url);
                }
            }

            return listSampleUrls;
        };


        /** Get the url of the probes page
         *
         * @method getProbesPageUrl
         * @param {Number} probeId The id of the probe
         * @param {Object} params A parameters vector
         * @return {String} An URL
         */

        this.getProbesPageUrl = function(probeId, params){
            return &#x27;https://atlas.ripe.net/dnsmon/probes/&#x27; + paramsManager.convertLocalToRemoteId(probeId)+ &#x27;?zone=&#x27; + paramsManager.convertLocalToRemoteId(params.root);
        };


        /** Get additional data-api URLs given a cell
         *
         * @method getDataUrls
         * @param {Object} cell A cell object
         * @return {Object} A map of URLs for the whole time window
         */

        this.getDataUrls = function(cell){
            var listOverviewUrls, urlTmp, row;

            row = cell.row;
            listOverviewUrls = row.urlsMap.overview;

            for (var n=0,length=listOverviewUrls.length; n&lt;length; n++){
                urlTmp = listOverviewUrls[n];

                urlTmp.url = utils.setParam(&#x27;format&#x27;, &#x27;json&#x27;, urlTmp.url);

                if (row.___type___ == &quot;probe&quot;){
                    urlTmp.url = utils.setParam(&#x27;prb_id&#x27;, paramsManager.convertLocalToRemoteId(row.id), urlTmp.url);
                }
            }

            return listOverviewUrls;
        };


        /** Get the DNS response, in a human readable format, given a cell
         *
         * @method getNativeDnsResult
         * @param {Object} cell A cell object
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this.getNativeDnsResult = function(cell, callback, context){
            var msmId, prbId, timestamp;

            msmId = this._getMeasurementId(cell);
            prbId = paramsManager.convertLocalToRemoteId(cell.row.id);
            timestamp = paramsManager.convertLocalToRemoteDate(cell.time);

            connector.getNativeDnsResult(msmId, prbId, timestamp, callback, context);
        };


        /** Get the closest traceroutes given a cell
         *
         * @method getClosestTraceroutes
         * @param {Object} cell A cell object
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this.getClosestTraceroutes = function(cell, callback, context){
            var msmId, prbId, timestamp, measurementType;

            measurementType = &quot;traceroute&quot;;

            msmId = this._getMeasurementIdByType(cell, measurementType);
            prbId = paramsManager.convertLocalToRemoteId(cell.row.id);
            timestamp = paramsManager.convertLocalToRemoteDate(cell.time);

            connector.getClosestTraceroutes(msmId, prbId, timestamp, callback, context);
        };


        /** Get the measurement id given a cell
         *
         * @method _getMeasurementId
         * @private
         * @param {Object} cell A cell object
         * @return {String} The measurement id
         */

        this._getMeasurementId = function(cell){
            var dataUrls, urlItem;

            dataUrls = this.getDataUrls(cell);

            for (var n=0,length=dataUrls.length; n&lt;length; n++){
                urlItem = dataUrls[n];
                if (urlItem.current == true){
                    return urlItem.measurementId;
                }
            }

            return null;
        };


        /** Get the DNS response, in a human readable format, given a cell
         *
         * @method _getMeasurementIdByType
         * @private
         * @param {Object} cell A cell object
         * @param {String} type A valid type
         * @return {Number} The measurement id
         */

        this._getMeasurementIdByType = function(cell, type){
            var dataUrls, urlItem;

            dataUrls = this.getDataUrls(cell);

            for (var n=0,length=dataUrls.length; n&lt;length; n++){
                urlItem = dataUrls[n];

                if (urlItem.type == type){
                    return urlItem.measurementId;
                }
            }

            return null;
        };

    };

    return ConnectorFacade;
});
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
