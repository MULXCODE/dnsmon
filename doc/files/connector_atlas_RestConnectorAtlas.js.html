<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>connector/atlas/RestConnectorAtlas.js - DNSMON</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="DNSMON"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 14.4.15.2</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/AggregationLevelConnector.html">AggregationLevelConnector</a></li>
            
                <li><a href="../classes/AntiFloodConnector.html">AntiFloodConnector</a></li>
            
                <li><a href="../classes/BreadcrumbsView.html">BreadcrumbsView</a></li>
            
                <li><a href="../classes/CacheConnectorAtlas.html">CacheConnectorAtlas</a></li>
            
                <li><a href="../classes/Cell.html">Cell</a></li>
            
                <li><a href="../classes/Connector.html">Connector</a></li>
            
                <li><a href="../classes/ConnectorFacade.html">ConnectorFacade</a></li>
            
                <li><a href="../classes/ControlPanelView.html">ControlPanelView</a></li>
            
                <li><a href="../classes/ErrorsHandlerConnectorAtlas.html">ErrorsHandlerConnectorAtlas</a></li>
            
                <li><a href="../classes/FullScreenView.html">FullScreenView</a></li>
            
                <li><a href="../classes/GesturesManager.html">GesturesManager</a></li>
            
                <li><a href="../classes/HistoryManager.html">HistoryManager</a></li>
            
                <li><a href="../classes/IsolationLevelConnectorAtlas.html">IsolationLevelConnectorAtlas</a></li>
            
                <li><a href="../classes/MainView.html">MainView</a></li>
            
                <li><a href="../classes/ParamsManager.html">ParamsManager</a></li>
            
                <li><a href="../classes/PopUpView.html">PopUpView</a></li>
            
                <li><a href="../classes/Row.html">Row</a></li>
            
                <li><a href="../classes/SessionManager.html">SessionManager</a></li>
            
                <li><a href="../classes/SvgChartView.html">SvgChartView</a></li>
            
                <li><a href="../classes/SvgContainerView.html">SvgContainerView</a></li>
            
                <li><a href="../classes/SvgOrdinalAxisView.html">SvgOrdinalAxisView</a></li>
            
                <li><a href="../classes/SvgTimeAxisView.html">SvgTimeAxisView</a></li>
            
                <li><a href="../classes/TemplateManagerView.html">TemplateManagerView</a></li>
            
                <li><a href="../classes/TimeController.html">TimeController</a></li>
            
                <li><a href="../classes/TimeOverviewView.html">TimeOverviewView</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/connector.html">connector</a></li>
            
                <li><a href="../modules/connector.Atlas.html">connector.Atlas</a></li>
            
                <li><a href="../modules/controller.html">controller</a></li>
            
                <li><a href="../modules/environment.html">environment</a></li>
            
                <li><a href="../modules/model.html">model</a></li>
            
                <li><a href="../modules/session.html">session</a></li>
            
                <li><a href="../modules/view.html">view</a></li>
            
                <li><a href="../modules/view.svg.html">view.svg</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: connector/atlas/RestConnectorAtlas.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
define([
    &quot;env.utils&quot;
], function(utils){

    /**
     * Connector is in charge of connecting the data-apis and providing a JSON format to the layers over.
     *
     * @class Connector
     * @constructor
     * @module connector.Atlas
     */

    var Connector = function(env){
        var perServerDataUrl, serversDataUrl, serversDataUrl, nativeDnsResultDataUrl, closesttraceroutesDataUrl, config;

        config = env.config;

        this.maxNumberOfCells = env.muxNumberOfCells || config.maxNumberOfCells;

        //weir-dev
        perServerDataUrl = (typeof DNSMON_PROBES_DATA_API_URL === &quot;undefined&quot;) ? &quot;https://weir-dev.atlas.ripe.net/dnsmon/api/probes&quot; : DNSMON_PROBES_DATA_API_URL;
        serversDataUrl = (typeof DNSMON_SERVERS_DATA_API_URL === &quot;undefined&quot;) ? &quot;https://weir-dev.atlas.ripe.net/dnsmon/api/servers&quot; : DNSMON_SERVERS_DATA_API_URL;

        nativeDnsResultDataUrl = (typeof DNSMON_ATLAS_DATA_API_URL === &quot;undefined&quot;) ? &quot;https://weir-dev.atlas.ripe.net/dnsmon/api/atlas-data&quot; : DNSMON_ATLAS_DATA_API_URL;
        closesttraceroutesDataUrl = (typeof DNSMON_ATLAS_TRACEROUTE_API_URL === &quot;undefined&quot;) ? &quot;https://weir-dev.atlas.ripe.net/dnsmon/api/atlas-data&quot; : DNSMON_ATLAS_TRACEROUTE_API_URL;

        this.getDataUrl = function(params){

            utils.log(params);
            var url = &quot;&quot;;

            if (params.type == &quot;zone-servers&quot;){

                utils.log(&quot;multi-server-data&quot;);

                url = serversDataUrl;
                url += (params.zone) ? &quot;?group=&quot; + params.zone : &quot;&quot;;
                url += (params.selectedRows.length &gt; 0) ? &quot;&amp;servers=&quot; + utils.join(params.selectedRows, &quot;,&quot;) : &quot;&quot;;

                //url += (!env.aggregationLevel) ? &quot;&quot; : &quot;&amp;min_aggregation=&quot; + env.aggregationLevel;

                url += (params.startTime) ? &quot;&amp;start_time=&quot; + params.startTime : &quot;&quot;;
                url += (params.endTime) ? &quot;&amp;end_time=&quot; + params.endTime : &quot;&quot;;

//                url += (!params.startTime &amp;&amp; !params.endTime &amp;&amp; env.timeWindowSeconds &amp;&amp; env.retrievedAggregationLevel != null &amp;&amp; !params.timeWindow) ? &quot;&amp;default_time_period=&quot; + (env.timeWindowSeconds + env.retrievedAggregationLevel - 1): &quot;&quot;;
                url += (!params.startTime &amp;&amp; !params.endTime &amp;&amp; params.timeWindow) ? &quot;&amp;default_time_period=&quot; + params.timeWindow : &quot;&quot;;

                url += (params.ipVersion) ? &quot;&amp;ip_version=&quot; + params.ipVersion : &quot;&quot;;
                url += (params.isTcp) ? &quot;&amp;is_tcp=&quot; + params.isTcp : &quot;&quot;;

                url += (env.maxNumberOfCellsPerRow) ? &quot;&amp;max_samples_per_row=&quot; + env.maxNumberOfCellsPerRow : &quot;&quot;;
                url += (this.maxNumberOfCells) ? &quot;&amp;max_samples=&quot; + this.maxNumberOfCells : &quot;&quot;;

            }else if(params.type == &quot;server-probes&quot;){

                utils.log(&quot;single-server-data&quot;);

                url = perServerDataUrl
                    + &quot;?server=&quot; + params.server;

                url += (params.zone) ? &quot;&amp;group=&quot; + params.zone : &quot;&quot;;

                url += &quot;&amp;filter_probes=&quot; + params.filterProbes;

                //url += (!env.aggregationLevel) ? &quot;&quot; : &quot;&amp;min_aggregation=&quot; + env.aggregationLevel;

                url += (params.selectedRows.length &gt; 0) ? &quot;&amp;probes=&quot; + utils.join(params.selectedRows, &quot;,&quot;) : &quot;&quot;;

                url += (params.startTime) ? &quot;&amp;start_time=&quot; + params.startTime : &quot;&quot;;
                url += (params.endTime) ? &quot;&amp;end_time=&quot; + params.endTime : &quot;&quot;;

//                url += (!params.startTime &amp;&amp; !params.endTime &amp;&amp; env.timeWindowSeconds &amp;&amp; env.retrievedAggregationLevel != null &amp;&amp; !params.timeWindow) ? &quot;&amp;default_time_period=&quot; + (env.timeWindowSeconds + env.retrievedAggregationLevel - 1): &quot;&quot;;
                url += (!params.startTime &amp;&amp; !params.endTime &amp;&amp; params.timeWindow) ? &quot;&amp;default_time_period=&quot; + params.timeWindow : &quot;&quot;;

                url += (params.ipVersion) ? &quot;&amp;ip_version=&quot; + params.ipVersion : &quot;&quot;;
                url += (params.isTcp) ? &quot;&amp;is_tcp=&quot; + params.isTcp : &quot;&quot;;

                url += (env.maxNumberOfCellsPerRow) ? &quot;&amp;max_samples_per_row=&quot; + env.maxNumberOfCellsPerRow : &quot;&quot;;
                url += (this.maxNumberOfCells) ? &quot;&amp;max_samples=&quot; + this.maxNumberOfCells : &quot;&quot;;
            }

            //url += (env.params.random) ? &quot;&amp;random=true&quot; : &quot;&quot;;
//        url += &quot;&amp;debug_levels=0,3600,86400,2592000&quot;;

            return url;
        };


        /**
         * It is strongly dedicated to a particular data-api.
         * From top to bottom: given some data-api valid parameters, it provides a method to connect to the data-api and query for that parameters.
         * From bottom to top: provides the raw JSON to the received callback.
         *
         * @method retrieveData
         * @param {Object} params A parameters vector valid for the data-api
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this.retrieveData = function(params, callback, context){
            var dataUrl, externalParams;

            externalParams = params;

            dataUrl = this.getDataUrl(externalParams);

            utils.log(dataUrl);

            $.ajax({
                dataType: &quot;jsonp&quot;,
                url: dataUrl,
                cache : false,
                method : &#x27;get&#x27;,
                timeout : 30000, // 30 secs of timeout FOR NOW

                success: function(data){

                    utils.log(&quot;Data retrieved&quot;);
                    data.type = params.type;
                    env.lastDownload = new Date();
                    callback.call(context, data);
                    delete data; // Force garbage
                },

                error: function(XMLHttpRequest, textStatus, errorThrown) {
                    var emptyDataSet;

                    utils.log(&quot;Connection failed&quot;);
                    emptyDataSet = {
                        messages: [
                            {type: &quot;connection-fail&quot;, text: errorThrown}
                        ]
                    };

                    callback.call(context, emptyDataSet);
                }

            });

        };


        /**
         * Get the DNS response from the data-api
         *
         * @method getNativeDnsResult
         * @param {Number} msmId The id of the measurement
         * @param {Number} prbId The id of the probe
         * @param {Number} timestamp A UNIX timestamp
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this.getNativeDnsResult = function(msmId, prbId, timestamp, callback, context){
            var dataUrl;

            dataUrl = utils.setParam(&#x27;msm_id&#x27;, msmId, nativeDnsResultDataUrl);
            dataUrl = utils.setParam(&#x27;prb_id&#x27;, prbId, dataUrl);
            dataUrl = utils.setParam(&#x27;timestamp&#x27;, timestamp, dataUrl);

            utils.log(&#x27;Retrieve native DNS data: &#x27;+ dataUrl);

            $.ajax({
                dataType: &quot;jsonp&quot;,
                url: dataUrl,
                success: function(data){
                    utils.log(&quot;Native DNS data retrieved&quot;);
                    callback.call(context, data);
                    delete data; // Force garbage
                },

                fail: function(){
                    utils.log(&quot;It is not possible to retrieve native DNS data&quot;);
                }
            });
        };


        /**
         * Get the closest traceroutes data from the data-api
         *
         * @method getClosestTraceroutes
         * @param {Number} msmId The id of the measurement
         * @param {Number} prbId The id of the probe
         * @param {Number} timestamp A UNIX timestamp
         * @param {Function} callback A function taking the retrieved data as input when it is ready
         * @param {Object} context The context of the callback
         */

        this.getClosestTraceroutes = function(msmId, prbId, timestamp, callback, context){
            var dataUrl;

            dataUrl = utils.setParam(&#x27;msm_id&#x27;, msmId, closesttraceroutesDataUrl);
            dataUrl = utils.setParam(&#x27;prb_id&#x27;, prbId, dataUrl);
            dataUrl = utils.setParam(&#x27;timestamp&#x27;, timestamp, dataUrl);
            dataUrl = utils.setParam(&#x27;surrounding&#x27;, config.tracerouteSurrounding, dataUrl);

            utils.log(&#x27;Retrieve traceroute data: &#x27;+ dataUrl);

            $.ajax({
                dataType: &quot;jsonp&quot;,
                url: dataUrl,
                success: function(data){
                    utils.log(&quot;Traceroute data retrieved&quot;);
                    callback.call(context, data);
                    delete data; // Force garbage
                },

                fail: function(){
                    utils.log(&quot;It is not possible to retrieve traceroute data&quot;);
                }
            });
        };
    };

    return Connector;
});

    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
